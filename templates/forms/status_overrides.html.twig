{#
# -------------------------------------------------------------------------
# Fields plugin for GLPI
# -------------------------------------------------------------------------
#
# LICENSE
#
# This file is part of Fields.
#
# Fields is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# Fields is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Fields. If not, see <http://www.gnu.org/licenses/>.
# -------------------------------------------------------------------------
# @copyright Copyright (C) 2013-2022 by Fields plugin team.
# @license   GPLv2 https://www.gnu.org/licenses/gpl-2.0.html
# @link      https://github.com/pluginsGLPI/fields
# -------------------------------------------------------------------------
#}

{% import 'components/form/fields_macros.html.twig' as fields %}
{% set rand = random() %}

{% if form_only is not defined or form_only == false %}
<div id="container{{ rand }}" class="asset {{ bg }}">
{% endif %}
   <form name="asset_form" method="post" action="{{ target }}" {{ formoptions|raw }} enctype="multipart/form-data" data-submit-once>
      <input type="hidden" name="container_id" value="{{ container_id }}" />
      {% if override is null %}
         {{ fields.largeTitle(__('Add new status override', 'fields'), '', true) }}
      {% else %}
         <div class="d-flex align-items-start mb-3">
            <button class="btn btn-primary me-2" type="button" name="switch_add" value="1">
               <i class="far fa-plus"></i>
               <span>{{ __('Add new status override', 'fields') }}</span>
            </button>
         </div>
         {{ fields.largeTitle(__('Edit status override', 'fields'), '', true) }}
      {% endif %}
      <div class="card-body pe-1 d-flex flex-wrap">
         <div class="col-12 flex-column">
            <div class="d-flex flex-row flex-wrap flex-xl-nowrap">
               <div class="row flex-row align-items-start flex-grow-1">
                  <div class="row flex-row">
                     {{ fields.dropdownArrayField('itemtype', override.itemtype|default(null), container_itemtypes, __('Item type')) }}
                     {{ fields.dropdownField('PluginFieldsField', 'plugin_fields_fields_id', override.plugin_fields_fields_id|default(null),  __("Field", "fields"), {
                        'condition': [{'plugin_fields_containers_id': container_id}]
                     }) }}
                     {% if override is not null %}
                        {{ fields.hiddenField('states_default', override.states|default('')|join(',')) }}
                     {% endif %}
                     {{ fields.htmlField('status_inner_container', '<div id="status_inner_container"></div>', __('Status'), {
                        add_field_attribs: {
                           hidden: 'hidden'
                        }
                     }) }}
                     {{ fields.dropdownYesNo('mandatory', override.mandatory|default(null), __('Mandatory field'), {
                        add_field_attribs: {
                           hidden: 'hidden'
                        }
                     }) }}
                     {{ fields.dropdownYesNo('is_readonly', override.is_readonly|default(null), __("Read only", "fields"), {
                        add_field_attribs: {
                           hidden: 'hidden'
                        }
                     }) }}
                  </div> {# .row #}
                  <div class="mx-n2 d-flex flex-row-reverse align-items-start">
                     {% if override is not null %}
                        <button class="btn btn-primary me-2" type="submit" name="update" value="1">
                           <i class="far fa-save"></i>
                           <span>{{ _x('button', 'Update') }}</span>
                        </button>
                     {% else %}
                        <button class="btn btn-primary me-2" type="submit" name="add" value="1">
                           <i class="far fa-plus"></i>
                           <span>{{ _x('button', 'Add') }}</span>
                        </button>
                     {% endif %}
                     <input type="hidden" name="_glpi_csrf_token" value="{{ csrf_token() }}" />
                  </div>
               </div> {# .row #}
            </div> {# .flex-row #}
         </div>
      </div> {# .card-body #}
   </form>

   {% if form_only is not defined or form_only == false %}
      {{ fields.largeTitle(__('Status overrides', 'fields'), '', false) }}
      <div class="card-body d-flex flex-wrap">
         <div class="col-12 flex-column">
            <div class="d-flex flex-row flex-wrap flex-xl-nowrap">
               <div class="row flex-row align-items-start flex-grow-1">
                  <div class="row flex-row">
                     <table class="table">
                        <thead>
                           <tr>
                              <th>{{ __('Item type') }}</th>
                              <th>{{ __('Field') }}</th>
                              <th>{{ __('Status') }}</th>
                              <th>{{ __('Mandatory') }}</th>
                              <th>{{ __('Read only') }}</th>
                              <th></th>
                           </tr>
                        </thead>
                        <tbody>
                           {% if overrides|length > 0 %}
                              {% for override in overrides %}
                                 <tr>
                                    <td>{{ override.itemtype }}</td>
                                    <td>{{ override.field_name }}</td>
                                    <td>{{ override.status_names|join(', ') }}</td>
                                    <td>{{ override.mandatory ? __('Yes') : __('No') }}</td>
                                    <td>{{ override.is_readonly ? __('Yes') : __('No') }}</td>
                                    <td>
                                       <input type="hidden" name="id" value="{{ override.id }}" />
                                       <button type="button" class="btn btn-sm btn-primary" name="edit"
                                               title="{{ _x('button', 'Edit') }}"
                                               data-bs-toggle="tooltip" data-bs-placement="top">
                                          <i class="ti ti-pencil"></i>
                                       </button>
                                       <form class="d-inline" method="post" action="{{ target }}">
                                          <input type="hidden" name="id" value="{{ override.id }}" />
                                          <button type="submit" class="btn btn-sm btn-danger" name="delete"
                                                  title="{{ _x('button', 'Delete permanently') }}"
                                                  data-bs-toggle="tooltip" data-bs-placement="top">
                                             <i class="ti ti-trash"></i>
                                          </button>
                                          <input type="hidden" name="_glpi_csrf_token" value="{{ csrf_token() }}" />
                                       </form>
                                    </td>
                                 </tr>
                              {% endfor %}
                           {% else %}
                              <tr>
                                 <td colspan="6">{{ __('No item found') }}</td>
                              </tr>
                           {% endif %}
                        </tbody>
                     </table>
                  </div> {# .row #}
               </div> {# .row #}
            </div> {# .flex-row #}
         </div>
      </div> {# .card-body #}
   {% endif %}
   {% if form_only is not defined or form_only == false %}
   <script>
      $(document).ready(() => {
          const refresh_status_dropdown = (initial = false) => {
              const itemtype = $('select[name="itemtype"]').val();
              $.ajax({
                  url: CFG_GLPI.root_doc + '/' + GLPI_PLUGINS_PATH.fields + '/ajax/status_override.php',
                  method: 'GET',
                  data: {
                      action: 'get_status_dropdown',
                      itemtype: itemtype
                  }
              }).then((result) => {
                  const status_container = $('#status_inner_container');
                  status_container.parent().removeClass('form-control-plaintext');
                  status_container.html(result);
                  status_container.closest('.form-field').attr('hidden', false);

                  if (initial) {
                      const default_status_input = $('input[name="states_default"]');

                      if (default_status_input.length > 0) {
                          $('select[name="states[]"]').val(default_status_input.val().split(',')).trigger('change');
                          // Remove the default status input
                          default_status_input.closest('.form-field').remove();
                      }
                  }

                  $('select[name="mandatory"]').closest('.form-field').attr('hidden', false);
                  $('select[name="is_readonly"]').closest('.form-field').attr('hidden', false);
              });
          }

          $('#container{{ rand }}').on('change', 'select[name="itemtype"]', () => {
              refresh_status_dropdown();
          });

          refresh_status_dropdown(true);

          $('#container{{ rand }}').on('click', 'button[name="edit"]', (e) => {
              const button = $(e.currentTarget);
              const row = button.closest('tr');
              const id = row.find('input[name="id"]').val();
              $.ajax({
                  url: CFG_GLPI.root_doc + '/' + GLPI_PLUGINS_PATH.fields + '/ajax/status_override.php',
                  method: 'GET',
                  data: {
                      action: 'get_edit_form',
                      statusoverride_id: id,
                      container_id: $('input[name="container_id"]').val()
                  }
              }).then((result) => {
                  $('form[name="asset_form"]').replaceWith(result);
                  refresh_status_dropdown(true);
              });
          });

          $('#container{{ rand }}').on('click', 'button[name="switch_add"]', (e) => {
              const button = $(e.currentTarget);
              const row = button.closest('tr');
              $.ajax({
                  url: CFG_GLPI.root_doc + '/' + GLPI_PLUGINS_PATH.fields + '/ajax/status_override.php',
                  method: 'GET',
                  data: {
                      action: 'get_add_form',
                      container_id: $('input[name="container_id"]').val()
                  }
              }).then((result) => {
                  $('form[name="asset_form"]').replaceWith(result);
                  refresh_status_dropdown(true);
              });
          });
      });
   </script>
</div>
{% endif %}
